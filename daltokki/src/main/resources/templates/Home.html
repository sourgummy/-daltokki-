<!DOCTYPE html>
<html lang="en">
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë‹¬í† ë¼</title>
    <!-- kakao -->
    <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/modalStyle.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Bootstrap JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>
<script>
   // ë§í¬ ê³µìœ  ëª¨ë‹¬ ì—´ê¸°
   function openCopyModal() {
       $("#ShareModal").modal("show");
   }

   // ë³µì‚¬ ê¸°ëŠ¥
  function CopyLink() {
      event.preventDefault(); // ëª¨ë‹¬ ì°½ ë‚´ë¶€ì˜ ë²„íŠ¼ í´ë¦­ì‹œ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸ ë§‰ê¸°

      const url = document.getElementById("CopyUrl");
      navigator.clipboard.writeText(url.value); // ì£¼ì†Œ ë³µì‚¬
      $("#ShareModal").modal("hide"); // ëª¨ë‹¬ ì°½ ë‹«ê¸°
  }

   // ëª¨ë‹¬ ë²„íŠ¼ - ì†¡í¸ ì§€ìš°ê¸°
   function DeleteSp() {
        const spId = $('#modalSpId').text(); // ìˆ˜ì •ëœ ë¶€ë¶„

        $.ajax({
               type: 'Post',
               url: 'deleteSp',
               data: { spId: spId },
               success: function(data) {
                   alert("ì†¡í¸ì´ ì‚­ì œë˜ì—ˆìŠ´ë‹ˆë‹¹!");
                   $('.row').load(location.href+' .row');
               }
        });
   }

    // ----------------------miju(08/18 ì¶”ê°€)-------------------------------
    // DOM ë¡œë”©ì´ ì™„ë£Œë˜ë©´ ì‹¤í–‰ë  í•¨ìˆ˜
    document.addEventListener("DOMContentLoaded", function() {
        var goToWriteSpButton = document.getElementById("goToWriteSpButton");
        var hiddenIdInput = document.getElementById("hiddenIdInput");

        // ë²„íŠ¼ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡í•˜ë„ë¡ ìˆ˜ì •(08/23)
        if (goToWriteSpButton) {

            goToWriteSpButton.addEventListener("click", function() {
                var id = hiddenIdInput.value;
                var url = 'writeSp?id=' + encodeURIComponent(id);
                location.href = url;
            });

        }
    });
    // ----------------------miju(08/18 ì¶”ê°€)-------------------------------
</script>
<body>
    <div class="container">
        <h1 th:inline="text"><span th:text="${param.id}"></span>ë‹˜ì˜ ë©”ì¸</h1>
        <img th:src="@{'/img/' + ${userInfo.get().rabbitType} + '.png'}" width="100px" height="100px">
        <div class="box">
            <div class="row">
                <div th:each="sp : ${spList}" class="col-md-4" style="text-align: center;">
                    <div style="width: 100px; hight: 100px; margin: 0 auto;">
                        <a href="#" data-toggle="modal" data-target="#ContentModal" th:data-spId="${sp.spId}">
                            <!-- DBì— ì €ì¥ëœ spColorì— ë§ëŠ” ì´ë¯¸ì§€ í‘œì‹œ -->
                            <img th:src="@{'/img/SP_' + ${sp.spColor} + '.png'}">
                            <br> <!-- ì´ë¯¸ì§€ì™€ í…ìŠ¤íŠ¸ë¥¼ êµ¬ë¶„ ìœ„í•´ ì¤„ ë°”ê¿ˆ : ë‹¤ë¥¸ ë°©ë²•ì´ ìˆë‚˜..? -->
                            <span th:text="${sp.spSender}" style="font-size: 12px;"></span>
                        </a>
                    </div>
                </div>
            </div>
            <div>
                <button class="btn-hover color-3paging" th:if="${currentPage > 0}" th:onclick="'location.href=\'' + @{/main(id=${id}, page=${currentPage - 1})} + '\''">â—</button>
                <button class="btn-hover color-3paging" th:if="${currentPage < totalPages - 1}" th:onclick="'location.href=\'' + @{/main(id=${id}, page=${currentPage + 1})} + '\''">â–¶</button>
            </div>
            </div>
        </div>

        <!-- í˜ì´ì§• ì»¨íŠ¸ë¡¤ -->
<!--        <div class="pagination">-->
<!--            <ul>-->
<!--                <li th:if="${currentPage > 0}">-->
<!--                    <a th:href="@{/main?id=${id}&amp;page=0}">First</a>-->
<!--                </li>-->
<!--                <li th:if="${currentPage > 0}">-->
<!--                    <a th:href="@{/main?id=${id}&amp;page=${currentPage - 1}}">Previous</a>-->
<!--                </li>-->
<!--                <li th:if="${currentPage < totalPages - 1}">-->
<!--                    <a th:href="@{/main?id=${id}&amp;page=${currentPage + 1}}">Next</a>-->
<!--                </li>-->
<!--                <li th:if="${currentPage < totalPages - 1}">-->
<!--                    <a th:href="@{/main?id=${id}&amp;page=${totalPages - 1}}">Last</a>-->
<!--                </li>-->
<!--            </ul>-->
<!--        </div>-->

        <div class="btn">
<!--             ë³¸ì¸ì˜ ì†¡í¸ í˜ì´ì§€ë©´ ë§í¬ ë²„íŠ¼ ì¶œë ¥-->
            <button th:if="${#strings.equals(#authentication.name, param.id) or #strings.equals(#authentication.name, tokenCode)}" id="shareKakao" onClick="sendLinkDefault()" class="btn-hover color-3mini">ì¹´ì¹´ì˜¤ ê³µìœ </button>
            <button th:if="${#strings.equals(#authentication.name, param.id) or #strings.equals(#authentication.name, tokenCode)}" id="shareLink" onclick="openCopyModal()" class="btn-hover color-3mini">ë§í¬ ê³µìœ </button>
            <!-- ë³¸ì¸ì˜ ì†¡í¸ í˜ì´ì§€ê°€ ì•„ë‹ˆë©´ ì†¡í¸ ì‘ì„± ë²„íŠ¼ ì¶œë ¥-->
            <button th:if="${!#strings.equals(#authentication.name, param.id) and !#strings.equals(#authentication.name, tokenCode)}" id="goToWriteSpButton" class="btn-hover color-3mini">ë©”ì‹œì§€ ì‘ì„±</button>
            <input type="hidden" id="hiddenIdInput" name="id" th:value="${param.id}">
        </div>
    </div>

    <!--ëª¨ë‹¬ ì˜ì—­ -->
    <!-- ë§í¬ê³µìœ  ëª¨ë‹¬ -->
    <div id="ShareModal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">ë§í¬ ê³µìœ </h4>
                </div>
                <div class="modal-body">
                    <div class="p-4 to-front">
                        <div class="text-center">
                            <div class="qr">
                                <img th:src="@{getQrcode(id=${param.id})}" alt="QR Code" class="img-fluid mb-4"/>
                            </div>
                            <br><p class="mb-4">ì¹œêµ¬ì—ê²Œ ë‹¬í† ë¼ë¥¼ ê³µìœ í•˜ì„¸ìš©!ğŸ°</p>
                            <form action="#" class="mb-4">
                                <div class="form-group">
                                    <input type="text" id="CopyUrl" class="form-control w-100 mr-3" th:value="${#httpServletRequest.getRequestURL()} + '?' + ${#httpServletRequest.getQueryString()}">
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
<!--                    <div class="row">-->
                    <div>
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <button class="btn btn-secondary" onclick="CopyLink()" style="color: #212539;">ë³µì‚¬í•˜ê¸°</button>
                                <button class="btn btn-primary" data-dismiss="modal">ë‹«ê¸°</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì†¡í¸ ë‚´ìš© ì¡°íšŒ ëª¨ë‹¬ -->
    <div id="ContentModal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-dialog-centered">
            <div class="selectmodal-content">
                <div class="modal-header">
                    <h3 class="modal-title"><span id="modalSpTitle"></h3><span id="modalSpId" style="color: rgba(255, 255, 255, 0);">
                    <button type="button" class="btn btn-default" data-dismiss="modal" onclick="DeleteSp()">ì§€ìš°ê¸°</button>
                </div>
                <div class="modal-body">
                    <div class="message-header">
                        <p class="message-sender">ë³´ë‚¸ì´: <span id="modalSpName"></span></p>
                        <p class="message-date">ë‚ ì§œ: <span id="modalSpdate"></span></p>
                    </div>
                    <div class="message-content">
                        <p><span id="modalSpContent"></span></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal" onclick="DeleteSp()">ì§€ìš°ê¸°</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

<!-- script -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const currentUserId = /*[[${#authentication.name}]]*/ ''; // í˜„ì¬ ì‚¬ìš©ìì˜ ì•„ì´ë””
        const paramId = /*[[${param.id}]]*/ ''; // param.id ê°’
        const tokenCode = /*[[${tokenCode}]]*/ ''; // í† í°ì½”ë“œ
        /*]]>*/

        $(document).ready(function() {
            // ì†¡í¸ ë‚´ìš© ì¡°íšŒ ëª¨ë‹¬
            $('#ContentModal').on('show.bs.modal', function(event) {
                console.log("currentUserId : " + currentUserId);
                console.log("paramId : " + paramId);
                console.log("tokenCode : " + tokenCode);

                // ì‹œíë¦¬í‹° ì„¸ì…˜(currentUserId)ê³¼ paramId ë˜ëŠ” í† í°ì„ ë¹„êµí•´ ì¼ì¹˜í•˜ëŠ” ìœ ì €ë§Œ ì†¡í¸ì„ ì¡°íšŒí•  ìˆ˜ ìˆê²Œ ì œì–´
                if (currentUserId != paramId && currentUserId != tokenCode) {
                    alert(paramId + " í† ë¼ë§Œ ì½ì„ ìˆ˜ ìˆì–´ìš”!ğŸ°");
                    return false;
                }

                const spId = $(event.relatedTarget).data('spid');
                console.log(spId);

                // ì†¡í¸ ë‚´ìš© ajaxë¡œ ì¡°íšŒ
                $.ajax({
                    type: 'GET',
                    url: 'findSp',
                    data: { spId: spId },
                    success: function(data) {
                        console.log(data);
                        // ëª¨ë‹¬ ë‚´ìš© ì—…ë°ì´íŠ¸
                        $('#modalSpTitle').text(data.spTitle);
                        $('#modalSpId').text(data.spId);
                        $('#modalSpName').text(data.spSender);
                        $('#modalSpdate').text(data.spCreateDate.substr(0,10));
                        $('#modalSpContent').text(data.spContent);
                    },
                    error: function(xhr, status, error) {
                        console.error('ì†¡í¸ ì¡°íšŒ ëª¨ë‹¬ AJAX ì—ëŸ¬ :', error);
                    }
                }); // ajax
            }); // event
        }); // document

        // ì¹´ì¹´ì˜¤ Custom -> ì–˜ëŠ” ëª¨ë‹¬ë¡œ ì•ˆëœë‹¤ê³  í•©ë‹ˆë‹¤.
        try {
<!--     alert("https://developers.kakao.com/main?id="+paramId);-->
<!--     alert("https://developers.kakao.com/main?id=" + encodeURIComponent(paramId));-->
<!--     alert(window.location.href);-->

        <!-- ì´ˆê¸°í™”ëŠ” í•œë²ˆë§Œ ë˜ì•¼í•˜ë¯€ë¡œ í•¨ìˆ˜ ë°–ì—ì„œ ì´ˆê¸°í™” í•¨ -->
         Kakao.init('efbfe79e4b4775d2088ca0e7d9a8edf1')

         function sendLinkDefault() {
           Kakao.Link.sendDefault({
             objectType: 'feed',
             content: {
               title: 'ë‹¬í† ë¼ğŸ°',
               description: 'ë°°ê³ í”ˆ í† ë¼ì—ê²Œ ìµœê³ ì˜ ì†¡í¸ì„ ë§Œë“¤ì–´ ì£¼ì„¸ìš”ğŸ˜¢ğŸ˜¢',
               imageUrl:
                 'http://k.kakaocdn.net/dn/bozSxc/btsp6qTBbFg/rQywrAKm7RY1uAcBbmdqrk/kakaolink40_original.png',
               link: {
                  mobileWebUrl: window.location.href,
                  webUrl:window.location.href,
               },
             },
             buttons: [
               {
                 title: 'ì›¹ìœ¼ë¡œ ë³´ê¸°',
                 link: {
                    mobileWebUrl: window.location.href,
                    webUrl: window.location.href,
                 },
               },
             ],
           })
         }
         ; window.kakaoDemoCallback && window.kakaoDemoCallback() }
         catch(e) { window.kakaoDemoException && window.kakaoDemoException(e) }
    </script>
</body>

</html>