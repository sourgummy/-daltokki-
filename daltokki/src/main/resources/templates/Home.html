<!DOCTYPE html>
<html lang="en">
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë‹¬í† ë¼</title>
    <!-- kakao -->
    <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/modalStyle.css">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Bootstrap JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>
<script>
   // ë§í¬ ê³µìœ  ëª¨ë‹¬ ì—´ê¸°
   function openCopyModal() {
       $("#ShareModal").modal("show");
   }

   // ë³µì‚¬ ê¸°ëŠ¥
  function CopyLink() {
      event.preventDefault(); // ëª¨ë‹¬ ì°½ ë‚´ë¶€ì˜ ë²„íŠ¼ í´ë¦­ì‹œ ë°œìƒí•˜ëŠ” ì´ë²¤íŠ¸ ë§‰ê¸°

      const url = document.getElementById("CopyUrl");
      navigator.clipboard.writeText(url.value); // ì£¼ì†Œ ë³µì‚¬
      $("#ShareModal").modal("hide"); // ëª¨ë‹¬ ì°½ ë‹«ê¸°
  }

   // ëª¨ë‹¬ ë²„íŠ¼ - ì†¡í¸ ì§€ìš°ê¸°
   function DeleteSp() {
        const spId = $('#modalSpId').text(); // ìˆ˜ì •ëœ ë¶€ë¶„

        $.ajax({
               type: 'Post',
               url: 'deleteSp',
               data: { spId: spId },
               success: function(data) {
                   alert("ì†¡í¸ì´ ì‚­ì œë˜ì—ˆìŠ´ë‹ˆë‹¹!");
                   $('.row').load(location.href+' .row');
               }
        });
   }

    // ----------------------miju(08/18 ì¶”ê°€)-------------------------------
    // DOM ë¡œë”©ì´ ì™„ë£Œë˜ë©´ ì‹¤í–‰ë  í•¨ìˆ˜
    document.addEventListener("DOMContentLoaded", function() {
        var goToWriteSpButton = document.getElementById("goToWriteSpButton");
        var hiddenIdInput = document.getElementById("hiddenIdInput");

        goToWriteSpButton.addEventListener("click", function() {
            var id = hiddenIdInput.value;
            var url = 'writeSp?id=' + encodeURIComponent(id);
            location.href = url;
        });
    });
    // ----------------------miju(08/18 ì¶”ê°€)-------------------------------
</script>
<body>
    <div class="container">
        <h1 th:inline="text"><span th:text="${param.id}"></span>ë‹˜ì˜ ë©”ì¸</h1>
        <img th:src="@{'/img/' + ${userInfo.get().rabbit_type} + '.png'}" width="100px" height="100px">
        <div class="box">
            <div class="row">
                <div th:each="sp : ${spList}" class="col-md-4" style="text-align:center">
                    <a href="#" data-toggle="modal" data-target="#ContentModal" th:data-spId="${sp.spId}">
                        <!-- DBì— ì €ì¥ëœ spColorì— ë§ëŠ” ì´ë¯¸ì§€ í‘œì‹œ -->
                        <img th:src="@{'/img/SP_' + ${sp.spColor} + '.png'}" width="100px" height="100px">
                        <br> <!-- ì´ë¯¸ì§€ì™€ í…ìŠ¤íŠ¸ë¥¼ êµ¬ë¶„ ìœ„í•´ ì¤„ ë°”ê¿ˆ : ë‹¤ë¥¸ ë°©ë²•ì´ ìˆë‚˜..? -->
                        <span th:text="${sp.spSender}"></span>
                    </a>
                </div>
            </div>
        </div>

        <div class="btn">
            <!-- ë³¸ì¸ì˜ ì†¡í¸ í˜ì´ì§€ë©´ ë§í¬ ë²„íŠ¼ ì¶œë ¥-->
            <button th:if="${#strings.equals(#authentication.name, param.id)}" id="shareKakao" onClick="sendLinkDefault()">ì¹´ì¹´ì˜¤ ê³µìœ </button>
            <button th:if="${#strings.equals(#authentication.name, param.id)}" id="shareLink" onclick="openCopyModal()">ë§í¬ ê³µìœ </button>
            <button id="googleLogin" onclick="location.href='/login/oauth2/code/google'">êµ¬ê¸€ ë¡œê·¸ì¸</button>
            <!-- ë³¸ì¸ì˜ ì†¡í¸ í˜ì´ì§€ê°€ ì•„ë‹ˆë©´ ì†¡í¸ ì‘ì„± ë²„íŠ¼ ì¶œë ¥-->
            <button th:if="${!#strings.equals(#authentication.name, param.id)}" id="goToWriteSpButton">ë©”ì‹œì§€ ì‘ì„±</button>
            <input type="hidden" id="hiddenIdInput" name="id" th:value="${param.id}">
        </div>
    </div>

    <!--ëª¨ë‹¬ ì˜ì—­ -->
    <!-- ë§í¬ê³µìœ  ëª¨ë‹¬ -->
    <div id="ShareModal" class="modal fade" role="dialog">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">ë§í¬ ê³µìœ </h4>
                </div>
                <div class="modal-body">
                    <div class="p-4 to-front">
                        <div class="text-center">
                            <div class="qr">
                                <img th:src="@{getQrcode(id=${param.id})}" alt="QR Code" class="img-fluid mb-4"/>
                            </div>
                            <br><p class="mb-4">ì¹œêµ¬ì—ê²Œ ë‹¬í† ë¼ë¥¼ ê³µìœ í•˜ì„¸ìš©!ğŸ°</p>
                            <form action="#" class="mb-4">
                                <div class="form-group">
                                    <input type="text" id="CopyUrl" class="form-control w-100 mr-3" th:value="${#httpServletRequest.getRequestURL()} + '?' + ${#httpServletRequest.getQueryString()}">
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <button class="btn btn-secondary btn-block" onclick="CopyLink()">ë³µì‚¬í•˜ê¸°</button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-primary btn-block" data-dismiss="modal">ë‹«ê¸°</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
<!--                        <button type="button" class="btn btn-primary" onclick="CopyLink()">ë³µì‚¬í•˜ê¸°</button>-->
<!--                        <button type="button" class="btn btn-default" data-dismiss="modal">ë‹«ê¸°</button>-->
<!--                        <button type="button" class="btn btn-primary" onclick="CopyLink()" style="width: 40%">ë³µì‚¬í•˜ê¸°</button>-->
<!--                        <button type="button" class="btn btn-default" data-dismiss="modal" style="width: 40%">ë‹«ê¸°</button>-->
                </div>
            </div>
        </div>
    </div>

    <!-- ì†¡í¸ ë‚´ìš© ì¡°íšŒ ëª¨ë‹¬ -->
    <div id="ContentModal" class="modal modal-bottom fade" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">ì†¡í¸</h4>
                    <button type="button" class="btn btn-default" data-dismiss="modal" onclick="DeleteSp()">ì§€ìš°ê¸°</button>
                </div>
                <div class="modal-body">
                    <div>
                        <span>ID: </span><span id="modalSpId"></span>
                    </div>
                    <div>
                        <span>Name: </span><span id="modalSpName"></span>
                    </div>
                    <div>
                        <span>Content: </span><span id="modalSpContent"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

<!-- script -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        const currentUserId = /*[[${#authentication.name}]]*/ ''; // í˜„ì¬ ì‚¬ìš©ìì˜ ì•„ì´ë””
        const paramId = /*[[${param.id}]]*/ ''; // param.id ê°’
        /*]]>*/

        console.log(currentUserId);
        console.log(paramId);

        $(document).ready(function() {
            // ì†¡í¸ ë‚´ìš© ì¡°íšŒ ëª¨ë‹¬
            $('#ContentModal').on('show.bs.modal', function(event) {
                // ë¡œê·¸ì¸ ì•„ì´ë””(currentUserId)ì™€ paramIdë¥¼ ë¹„êµí•´ ì¼ì¹˜í•˜ëŠ” ìœ ì €ë§Œ ì†¡í¸ì„ ì¡°íšŒí•  ìˆ˜ ìˆê²Œ ì œì–´
                if (currentUserId != paramId) {
                    alert(paramId + " í† ë¼ë§Œ ì½ì„ ìˆ˜ ìˆì–´ìš”!ğŸ°");
                    return false;
                }

                const spId = $(event.relatedTarget).data('spid');
                console.log(spId);

                // ì†¡í¸ ë‚´ìš© ajaxë¡œ ì¡°íšŒ
                $.ajax({
                    type: 'GET',
                    url: 'findSp',
                    data: { spId: spId },
                    success: function(data) {
                        console.log(data);
                        // ëª¨ë‹¬ ë‚´ìš© ì—…ë°ì´íŠ¸
                        $('#modalSpId').text(data.spId);
                        $('#modalSpName').text(data.spSender);
                        $('#modalSpContent').text(data.spContent);
                    },
                    error: function(xhr, status, error) {
                        console.error('ì†¡í¸ ì¡°íšŒ ëª¨ë‹¬ AJAX ì—ëŸ¬ :', error);
                    }
                }); // ajax
            }); // event
        }); // document

        // ì¹´ì¹´ì˜¤ Custom -> ì–˜ëŠ” ëª¨ë‹¬ë¡œ ì•ˆëœë‹¤ê³  í•©ë‹ˆë‹¤.
        try {
<!--     alert("https://developers.kakao.com/main?id="+paramId);-->
<!--     alert("https://developers.kakao.com/main?id=" + encodeURIComponent(paramId));-->
<!--     alert(window.location.href);-->

         function sendLinkDefault() {
           Kakao.init('efbfe79e4b4775d2088ca0e7d9a8edf1')
           Kakao.Link.sendDefault({
             objectType: 'feed',
             content: {
               title: 'ë‹¬í† ë¼ğŸ°',
               description: 'ë°°ê³ í”ˆ í† ë¼ì—ê²Œ ìµœê³ ì˜ ì†¡í¸ì„ ë§Œë“¤ì–´ ì£¼ìƒˆìš”ğŸ˜¢ğŸ˜¢',
               imageUrl:
                 'http://k.kakaocdn.net/dn/bozSxc/btsp6qTBbFg/rQywrAKm7RY1uAcBbmdqrk/kakaolink40_original.png',
               link: {
                  mobileWebUrl: window.location.href,
                  webUrl:window.location.href,
               },
             },
             buttons: [
               {
                 title: 'ì›¹ìœ¼ë¡œ ë³´ê¸°',
                 link: {
                    mobileWebUrl: window.location.href,
                    webUrl: window.location.href,
                 },
               },
             ],
           })
         }
         ; window.kakaoDemoCallback && window.kakaoDemoCallback() }
         catch(e) { window.kakaoDemoException && window.kakaoDemoException(e) }
    </script>
</body>

</html>